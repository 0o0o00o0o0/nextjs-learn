{"ast":null,"code":"function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React from 'react';\nimport dva, { connect } from 'dva-no-router';\nimport { Provider } from 'react-redux';\nimport model from \"../model/index\";\n\nconst checkServer = () => Object.prototype.toString.call(global.process) === '[object process]'; // eslint-disable-next-line\n\n\nconst __NEXT_DVA_STORE__ = '__NEXT_DVA_STORE__';\n\nfunction createDvaStore(initialState) {\n  let app;\n\n  if (initialState) {\n    app = dva({\n      initialState\n    });\n  } else {\n    app = dva({});\n  }\n\n  const isArray = Array.isArray(model);\n\n  if (isArray) {\n    model.forEach(m => {\n      app.model(m);\n    });\n  } else {\n    app.model(model);\n  }\n\n  app.router(() => {});\n  app.start(); // console.log(app);\n  // eslint-disable-next-line\n\n  const store = app._store;\n  return store;\n}\n\nfunction getOrCreateStore(initialState) {\n  const isServer = checkServer();\n\n  if (isServer) {\n    // run in server\n    // console.log('server');\n    return createDvaStore(initialState);\n  } // eslint-disable-next-line\n\n\n  if (!window[__NEXT_DVA_STORE__]) {\n    // console.log('client');\n    // eslint-disable-next-line\n    window[__NEXT_DVA_STORE__] = createDvaStore(initialState);\n  } // eslint-disable-next-line\n\n\n  return window[__NEXT_DVA_STORE__];\n}\n\nexport default function withDva(...args) {\n  return function CreateNextPage(Component) {\n    const ComponentWithDva = (props = {}) => {\n      const {\n        store,\n        initialProps,\n        initialState\n      } = props;\n      const ConnectedComponent = connect(...args)(Component);\n      return React.createElement(Provider, // in client side, it will init store with the initial state tranfer from server side\n      {\n        store: store && store.dispatch ? store : getOrCreateStore(initialState)\n      }, // transfer next.js's props to the page\n      React.createElement(ConnectedComponent, initialProps));\n    };\n\n    ComponentWithDva.getInitialProps = async (props = {}) => {\n      // console.log('get......');\n      const isServer = checkServer();\n      const store = getOrCreateStore(props.req); // call children's getInitialProps\n      // get initProps and transfer in to the page\n\n      const initialProps = Component.getInitialProps ? await Component.getInitialProps(_objectSpread(_objectSpread({}, props), {}, {\n        isServer,\n        store\n      })) : {};\n      return {\n        store,\n        initialProps,\n        initialState: store.getState()\n      };\n    };\n\n    return ComponentWithDva;\n  };\n}","map":{"version":3,"sources":["E:/zsDir/nextjs-learn/utils/store.ts"],"names":["React","dva","connect","Provider","model","checkServer","Object","prototype","toString","call","global","process","__NEXT_DVA_STORE__","createDvaStore","initialState","app","isArray","Array","forEach","m","router","start","store","_store","getOrCreateStore","isServer","window","withDva","args","CreateNextPage","Component","ComponentWithDva","props","initialProps","ConnectedComponent","createElement","dispatch","getInitialProps","req","getState"],"mappings":"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","sourcesContent":["import React from 'react';\nimport dva, { connect } from 'dva-no-router';\nimport { Provider } from 'react-redux';\nimport model from '../model/index';\n\nconst checkServer = () => Object.prototype.toString.call(global.process) === '[object process]';\n\n// eslint-disable-next-line\nconst __NEXT_DVA_STORE__ = '__NEXT_DVA_STORE__'\n\nfunction createDvaStore(initialState) {\n  let app;\n  if (initialState) {\n    app = dva({\n      initialState,\n    });\n  } else {\n    app = dva({});\n  }\n  const isArray = Array.isArray(model);\n  if (isArray) {\n    model.forEach((m) => {\n      app.model(m);\n    });\n  } else {\n    app.model(model);\n  }\n  app.router(() => { });\n  app.start();\n  // console.log(app);\n  // eslint-disable-next-line\n  const store = app._store\n  return store;\n}\n\nfunction getOrCreateStore(initialState) {\n  const isServer = checkServer();\n  if (isServer) { // run in server\n    // console.log('server');\n    return createDvaStore(initialState);\n  }\n  // eslint-disable-next-line\n  if (!window[__NEXT_DVA_STORE__]) {\n    // console.log('client');\n    // eslint-disable-next-line\n    window[__NEXT_DVA_STORE__] = createDvaStore(initialState);\n  }\n  // eslint-disable-next-line\n  return window[__NEXT_DVA_STORE__];\n}\n\nexport default function withDva(...args) {\n  return function CreateNextPage(Component) {\n    const ComponentWithDva = (props: any = {}) => {\n      const { store, initialProps, initialState } = props;\n      const ConnectedComponent = connect(...args)(Component);\n      return React.createElement(\n        Provider,\n        // in client side, it will init store with the initial state tranfer from server side\n        { store: store && store.dispatch ? store : getOrCreateStore(initialState) },\n        // transfer next.js's props to the page\n        React.createElement(ConnectedComponent, initialProps),\n      );\n    };\n    ComponentWithDva.getInitialProps = async (props: { req?: any } = {}) => {\n      // console.log('get......');\n      const isServer = checkServer();\n      const store = getOrCreateStore(props.req);\n      // call children's getInitialProps\n      // get initProps and transfer in to the page\n      const initialProps = Component.getInitialProps\n        ? await Component.getInitialProps({ ...props, isServer, store })\n        : {};\n      return {\n        store,\n        initialProps,\n        initialState: store.getState(),\n      };\n    };\n    return ComponentWithDva;\n  };\n}\n"]},"metadata":{},"sourceType":"module"}